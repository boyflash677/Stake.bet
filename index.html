"""
────────────────────────────────────────
  LoliPop Store – Single-file Server
  (Flask + Telegram bot + HTML landing)
────────────────────────────────────────
Run:   pip install python-telegram-bot==20.1 Flask==3.0.3
       python app.py
Deploy: Railway / Render / Termux + ngrok
"""

from flask import Flask, request, jsonify, Response
from telegram import Bot, ParseMode

TOKEN   = "7965746766:AAHTCgZJteje4WvRn4Rxr0aapzg7wmvujG0"   # keep secret
CHAT_ID = 1972373864                                         # your TG ID / channel

bot = Bot(TOKEN)
app = Flask(__name__)

# ──────────────────────────────────────────────────
# HTML LANDING PAGE (10 placeholder products)
# ──────────────────────────────────────────────────
HTML_PAGE = """
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LoliPop Store</title>
<style>
:root { --accent:#ff5dad; --dark:#111; --light:#fff; }
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--light);color:var(--dark);}
.hero{padding:3rem 1rem;text-align:center;background:linear-gradient(135deg,#ff5dad 0%,#ffffff 100%);}
.hero h1{font-size:2.5rem;margin:0;font-weight:900;letter-spacing:.02em;}
.container{padding:2rem 1rem;max-width:900px;margin:auto;}
.product-card{border:2px solid var(--accent);border-radius:1rem;overflow:hidden;margin-bottom:2rem;box-shadow:0 4px 16px rgba(0,0,0,.08);}
.product-card img{width:100%;height:auto;display:block;}
.product-info{padding:1rem;}
.product-info h2{margin:.4rem 0;font-size:1.2rem;}
.price{font-size:1.05rem;margin-bottom:.6rem;}
.price del{color:#777;margin-right:.4rem;}
.btn{display:inline-block;background:var(--accent);color:var(--light);padding:.55rem 1.1rem;font-weight:700;border-radius:.6rem;text-decoration:none;}
footer{text-align:center;padding:1rem 0;color:#666;border-top:1px solid #eee;font-size:.9rem;}
/* modal */
#orderModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
#orderModal form{background:#fff;padding:2rem;border-radius:1rem;max-width:420px;width:90%;}
#orderModal input,#orderModal textarea{width:100%;padding:.6rem;margin:.35rem 0;border:1px solid #ccc;border-radius:.4rem;}
</style>
</head><body>

<section class="hero">
  <h1>LoliPop Store</h1>
  <p>COD • Free Shipping • Limited Stock</p>
</section>

<div class="container" id="products">

<!-- ===== 10 Placeholder Products (edit as needed) ===== -->
{% for i in range(1,11) %}
  <div class="product-card" data-name="Sample Product {{i}}" data-price="₹499" data-mrp="₹999">
    <img src="https://via.placeholder.com/640x640.png?text=Product+{{i}}" alt="Product {{i}}">
    <div class="product-info">
      <h2>Sample Product {{i}}</h2>
      <p class="price"><del>₹999</del> <span>₹499</span></p>
      <a href="#order" class="btn">Order Now</a>
    </div>
  </div>
{% endfor %}
<!-- ==================================================== -->

</div>

<footer>© 2025 LoliPop Store</footer>

<!-- Order Modal -->
<div id="orderModal">
  <form id="orderForm">
    <h2 id="modalTitle">Order</h2>
    <input type="hidden" id="prodName">
    <input type="hidden" id="prodPrice">
    <label>Full Name*<input required id="custName" placeholder="Rahul Mehra"></label>
    <label>Phone*<input required id="custPhone" placeholder="9876543210"></label>
    <label>Address*<textarea required id="custAddr" rows="3" placeholder="123 MG Road, Mumbai – 400001"></textarea></label>
    <label>Quantity*<input type="number" min="1" value="1" id="custQty"></label>
    <button class="btn" type="submit">Place Order</button>
  </form>
</div>

<script>
// open modal
document.querySelectorAll(".btn").forEach(btn=>{
  btn.onclick=e=>{
    const card=e.target.closest(".product-card");
    document.getElementById("modalTitle").innerText="Order – "+card.dataset.name;
    document.getElementById("prodName").value=card.dataset.name;
    document.getElementById("prodPrice").value=card.dataset.price;
    document.getElementById("orderModal").style.display="flex";
  };
});
document.getElementById("orderModal").onclick=e=>{
  if(e.target.id==="orderModal")e.target.style.display="none";
};
// submit order
document.getElementById("orderForm").onsubmit=async e=>{
  e.preventDefault();
  const data={
    product:document.getElementById("prodName").value,
    price  :document.getElementById("prodPrice").value,
    name   :document.getElementById("custName").value,
    phone  :document.getElementById("custPhone").value,
    address:document.getElementById("custAddr").value,
    qty    :document.getElementById("custQty").value
  };
  try{
    const r=await fetch("/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
    if((await r.json()).ok){
      alert("Order placed! Confirmation sent on Telegram.");
      document.getElementById("orderModal").style.display="none";
      e.target.reset();
    }else throw 0;
  }catch{ alert("Error! Try again."); }
};
</script>

</body></html>
"""

# ──────────────────────────────────────────────────
# ROUTES
# ──────────────────────────────────────────────────
@app.route("/")
def home():
    # simple Jinja-style replace for placeholders
    page = HTML_PAGE.replace("{% for i in range(1,11) %}", "") \
                    .replace("{% endfor %}", "") \
                    .replace("{{i}}", "{i}")      # temp escape
    rendered = "\n".join(page.format(i=i) for i in range(1,11))
    return Response(rendered, mimetype="text/html")


@app.route("/order", methods=["POST"])
def receive_order():
    data = request.json or {}
    required = ("product","price","name","phone","address","qty")
    if not all(k in data and data[k] for k in required):
        return jsonify(ok=False, error="bad data"), 400

    msg = (
        "📦 *New Order – LoliPop Store*\n\n"
        f"👕 *Product:* {data['product']}\n"
        f"💰 *Price:* {data['price']}\n"
        f"🙍 *Name:* {data['name']}\n"
        f"📞 *Phone:* {data['phone']}\n"
        f"🏠 *Address:* {data['address']}\n"
        f"📦 *Qty:* {data['qty']}"
    )
    bot.send_message(chat_id=CHAT_ID, text=msg, parse_mode=ParseMode.MARKDOWN)
    return jsonify(ok=True)

# ──────────────────────────────────────────────────
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
